<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Tàu tết Đinh Dậu 2017 | Đường sắt Việt Nam</title>
        <meta name="description" content="Giờ tàu, giá vé, kế hoạch chạy tàu tết 2017 Đinh Dậu">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <!-- <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css"> -->
        <link href="https://fonts.googleapis.com/css?family=EB+Garamond&amp;subset=vietnamese" rel="stylesheet"> 

        <style type="text/css">
        
            html {
                font-family: 'EB Garamond', serif;
            }

            svg {
                font-family: 'EB Garamond', serif;
            }

            .line {
                stroke-width: 1px;
                stroke: #000;
            }

            .station {
                stroke-width: 0px;
                fill: red;
            }

            .train {
                stroke-width: 0px;
                fill: blue;
            }

            .station_label {
                text-anchor: end
            }

            .train_label {

            }
            
            .headline {
                position: fixed;
                bottom: 200px;
                left: 300px;
                width: 300px;
                background: #000;
                color: #fff;
                font-family: 'EB Garamond', serif;
                padding: 3px;
                line-height: 1.3;
            }

        </style>

    </head>
    <body>
        
        <h1>Kết hoạch chạy tàu Tết 2017, Tết Đinh Dậu <small>&lt;Đang cập nhật&gt;</small></h1>
        <p>Thông tin chi tiết về kế hoạch chạy tàu tết 2017 của đường sắt Việt Nam được biên tập lại trong 1 trang web duy nhất, dành cho các bạn quan tâm đến tàu tết trên CLB Đam mê Đường sắt, hi vọng đây là nguồn tham khảo bổ ích cho những ai quân tâm đến ngành đường sắt, các bạn đang học các ngành liên quan đến vận tải kinh tế đường sắt...</p>
        <p>CHÚ Ý: Đây không phải là trang web chính thức của ngành đường sắt, website không cung cấp các chức năng bán vé cũng như các thông tin chính thống và mới nhất về tàu tết 2017, nếu là hành khách có nhu cầu mua vé, xin vui lòng truy cập trang web http://dsvn.vn, để xem giờ tàu giá vé, xin vui lòng truy cập trang web http://giotaugiave.dsvn.vn/</p>
        <p>Dữ liệu: Kế hoạch chạy tàu tết của ĐSVN, http://dsvn.vn<br>Biên tập: Lê Nhật Anh, Nguyễn Thành Bình Nguyên (CLB Đam mê Đường sắt)<br>Thiết kế: Lê Nhật Anh<br>Chỉnh sửa lần cuối: 04 tháng 12, 2016<br>(c) 2017 . Giấy phép: MIT cho mã nguồn, CC BY 4.0 cho nội dung.</p>
        <h2>Thời gian</h2>
        <p>Đang cập nhật</p>
        <h2>Ram xe</h2>
        <p>Đang cập nhật</p>
        <h2>Lịch chạy</h2>
        <p>Đang cập nhật</p>
        <h2>Đầu máy</h2>
        <p>Đang cập nhật</p>
        <h2>Biểu đồ chạy tàu</h2>
        <p>Đang cập nhật</p>
        <div id="bieudo"></div>
        
        <h2>Vé</h2>
        <p>Đang cập nhật</p>

        <!-- Add your site or application content here -->
        <div class="headline">
            Mô phỏng chạy tàu theo kế hoạch 2146<br>1s tương đương 3 phút<br>
            <span id="timer">00:00</span>
        </div>

        <script src="d3.min.js"></script>
        <script>



        var lineLength = 1726,
            scaleRatio = 2,
            width = 1100,
            height = (lineLength + 20) * scaleRatio;

        var svg = d3.select("#bieudo").append("svg")
            .attr("width", width)
            .attr("height", height);

        var scale = d3.scaleLinear().domain([0, 1726]).range([0, 1726 * scaleRatio])

        // 1. KM Axis
        var axisKM = d3.axisLeft(scale);
        svg.append('g')
            .attr("transform", "translate(40,20)")
            .call(axisKM)
        
        // 2. Marley time Axis
        var scaleTime = d3.scaleTime()
            .domain([new Date(2016, 0, 15, 0), new Date(2016, 0, 16, 0)])
            .range([0, 720])
        //scaleTime.ticks(d3.timeMinute.every(15))
        var axisTime = d3.axisTop(scaleTime)
            .ticks(24)
            .tickFormat(d3.timeFormat("%H:%M"))
        svg.append('g')
            .attr("transform", "translate(350,20)")
            .call(axisTime)
        
        //2.1 Line
        var lineForMarley = d3.line()
            .x(function(d) { return scale(d.km); })
            .y(function(d) { return scaleTime(d.time); });

        // 2. Route
        var routeSvg = svg.append('g')
            .attr("class", "route")
            .attr("transform", "translate(200,20)")
            .attr("font-size", "10px")


        // load data and process
        d3.json("data_e.json", function(data) {
            // process flexiable data for D3
            var dataLines = [];
            var i = 0;
            for (var d in data.sections) {
                dataLines[i] = data.sections[d];
                i++;
            }

            var dataStations = [];
            var i = 0;
            for (var d in data.stations) {
                dataStations[i] = data.stations[d];
                i++;
            }

            var lines = routeSvg.selectAll('.line').data(dataLines)
            var stations = routeSvg.selectAll('.station').data(dataStations)
            var stationLabels = routeSvg.selectAll('.station_label').data(dataStations)
            var stationTicks = routeSvg.selectAll('.station_tick').data(dataStations)

            lines.enter().append('line')
                .attr('class', 'line')
                .attr('x1', 0)
                .style('shape-rendering','crispEdges')
                .attr('y1', function (d) { return scale(data.stations[d.station1].km); })
                .attr('x2', 0)
                .attr('y2', function (d) { return scale(data.stations[d.station2].km); });

            // stations.enter().append('circle')
            //     .attr('class', 'station')
            //     .attr("cx", 0)
            //     .attr("cy", function(d) { return (scale(d.postKm)); })
            //     .attr("r", 2)

            stationLabels.enter().append('text')
                .attr('class', 'station_label')
                .attr("x", function (d, i) { return i % 2 === 0 ? '-75' : '-15'})
                .attr("y", function (d) { return (scale(d.km)); })
                .attr("dy", "0.32em")
                .text(function (d) { return d.name })

            stationTicks.enter().append('line')
                .attr('class', 'station_tick')
                .attr('fill', 'none')
                .attr('stroke', '#000')
                .style('shape-rendering','crispEdges')
                .attr("y2", function (d, i) { return (scale(d.km)) })
                .attr("y1", function (d, i) { return (scale(d.km)) })
                .attr("x1", function (d, i) { return i % 2 === 0 ? '-70' : '-10'})
                .attr("x2", "-3")

            var timeToMin = function(time)
            {
                parts = time.split(":")
                return parseInt(parts[0]) * 60 + parseInt(parts[1])
            }

            var dayToMin = function(day) {
                return day * 24 * 60
            }

            // Train data
            var trains = []
            var trainCircles = []
            var trainLastPos = []
            var trainLabels = []

            var setTrainsByTime = function(time)
            {
                var total = trains.length
                for (i = 0; i < total; i++) {
                    setTrainByTime(i, time)
                }
            }

            var setTrainByTime = function(index, time) {
                if (time < trains[index].start) {
                    trainCircles[index].style("opacity", 0)
                    trainLabels[index].style("opacity", 0)
                    return;
                }

                if (time > trains[index].end) {
                    trainCircles[index].style("opacity", 0)
                    trainLabels[index].style("opacity", 0)
                    return;
                }

                var route = 0
                if (trainLastPos[index] === null) {
                    var totalRoutes = trains[index].route.length
                    var totalTimes = trains[index].end - trains[index].start
                    var avgTimeForRoute = totalTimes / totalRoutes
                    var currentTime = time - trains[index].start
                    var preRoutes = Math.ceil(currentTime / avgTimeForRoute) - 1
                    preRoutes = preRoutes < 0 ? 0 : preRoutes
                    preRoutes = preRoutes > totalRoutes ? totalRoutes : preRoutes
                    var direction = 1
                    if (time < trains[index].route[preRoutes].start) {
                        direction = -1
                    }

                    do {
                        if (trains[index].route[preRoutes].start <= time && trains[index].route[preRoutes].out >= time) {
                            route = preRoutes
                            break;
                        }
                        preRoutes = preRoutes + direction
                    } while (true)
                } else {
                    route = trainLastPos[index]
                    do {
                        if (trains[index].route[route].start <= time && trains[index].route[route].out >= time) {
                            break
                        }
                        route++
                    } while (true)
                }

                var station1 = trains[index].route[route].station1
                var station2 = trains[index].route[route].station2
                var routeLenght = data.stations[station2].km - data.stations[station1].km;
                var routeDuration = trains[index].route[route].in - trains[index].route[route].start;
                var routeRunningTime = trains[index].route[route].in - time;
                if (routeRunningTime < 0) routeRunningTime = 0;
                routeRunningTime = routeDuration - routeRunningTime;
                var currentPos = data.stations[station1].km + routeRunningTime * routeLenght / routeDuration;
                trainCircles[index].style("opacity", 1);
                trainCircles[index].attr("cy", currentPos * scaleRatio)
                trainCircles[index].attr("cy", currentPos * scaleRatio)
                trainLabels[index].style("opacity", 1);
                trainLabels[index].attr("y", currentPos * scaleRatio)
                trainLastPos[index] = route
            }

            var createTrain = function(name, route, day)
            {
                var train = {
                    'name': name + '_' + day,
                    'start': '',
                    'end': '',
                    'route': []
                }

                var i = 0;
                for (var key in data.routes[route].sections) {
                    var dayStart = data.routes[route].sections[key].time1OutDay + day
                    var dayIn = data.routes[route].sections[key].time2InDay + day
                    var dayOut = data.routes[route].sections[key].time2OutDay + day
                    var timeStart = timeToMin(data.routes[route].sections[key].time1Out)
                    var timeIn = timeToMin(data.routes[route].sections[key].time2In)
                    var timeOut = timeToMin(data.routes[route].sections[key].time2Out)

                    train.route[i] = {}
                    train.route[i].start = timeStart + dayToMin(dayStart)
                    train.route[i].in = timeIn + dayToMin(dayIn)
                    train.route[i].out = timeOut + dayToMin(dayOut)
                    train.route[i].station1 = data.routes[route].sections[key].station1
                    train.route[i].station2 = data.routes[route].sections[key].station2

                    i++;
                }

                train.start = train.route[0].start
                train.end = train.route[i-1].out

                // add data
                trains.push(train)

                // add cirlce
                var cir = routeSvg.append('circle')
                    //.attr('id', 'train_se1')
                    .attr('class', 'train')
                    .attr("cx", 0)
                    .attr("cy", 0)
                    .attr("r", 2)
                    .style("opacity", 0)
                trainCircles.push(cir)

                // add label
                var text = routeSvg.append('text')
                    .attr('class', 'train_label')
                    .attr("x", 5)
                    .attr("y", 0)
                    .attr("dy", "0.32em")
                    .text(train.name)
                    .style("opacity", 0)
                trainLabels.push(text)

                trainLastPos.push(null)
            }
            
            var resetLastPost = function() {
                for (var pos in trainLastPos) {
                    trainLastPos[pos] = null
                }
            }
            
            var timer = d3.select("#timer")
            
            var updateTimer = function(time) {
                var midnightToNow = Math.round(time) % (60 * 24);
                var hh = Math.floor(midnightToNow / 60);
                var mm = midnightToNow - (hh * 60);
                
                hh = hh < 10 ? '0' + hh : hh;
                mm = mm < 10 ? '0' + mm : mm;
                
                timer.text(hh + ":" + mm + ":00")
            }
            
            // var makeTrainPath()
      //       {
      //           var train = svg.append("g")
      //               .attr("class", "train")
      //               .attr("clip-path", "url(#clip)")
      //           .selectAll("g")
      //               .data(trains)
      //         .enter().append("g")
      //           //.attr("class", function(d) { return d.type; });
      //     train.append("path")
      //           .attr("d", function(d) { return lineForMarley(d.route); });
      //
      //       }



            for(i = 0; i <= 4; i++) {
                createTrain('se1', 'se1', i)
                createTrain('se3', 'se3', i)
                createTrain('se5', 'se5', i)
                createTrain('se7', 'se7', i)
                createTrain('tn1', 'tn1', i)
                createTrain('tn3', 'tn3', i)
                createTrain('tn5', 'tn5', i)
                createTrain('tn7', 'tn7', i)
                createTrain('se9', 'se9', i)
                createTrain('se11', 'se11', i)
                createTrain('se13', 'se13', i)
                createTrain('se14', 'se14', i)
                createTrain('se17', 'se17', i)
                createTrain('se18', 'se18', i)
                createTrain('se29', 'se29', i)
                createTrain('se30', 'se30', i)
                createTrain('se23', 'se23', i)
                createTrain('se24', 'se24', i)
                createTrain('sqn1', 'sqn1', i)
                createTrain('sqn2', 'sqn2', i)
                createTrain('snt2', 'snt2', i)
                createTrain('snt4', 'snt4', i)
                createTrain('snt3', 'snt3', i)

                createTrain('se2', 'se2', i)
                createTrain('se4', 'se4', i)
                createTrain('se6', 'se6', i)
                createTrain('se8', 'se8', i)
                createTrain('tn2', 'tn2', i)
                createTrain('tn4', 'tn4', i)
                createTrain('tn6', 'tn6', i)
                createTrain('tn8', 'tn8', i)
                createTrain('se10', 'se10', i)
                createTrain('se12', 'se12', i)
                createTrain('spt2', 'spt2', i)
                createTrain('se22', 'se22', i)
                createTrain('se26', 'se26', i)
                createTrain('snt2', 'snt2', i)
                createTrain('spt1', 'spt1', i)
                createTrain('se21', 'se21', i)
                createTrain('se25', 'se25', i)
                createTrain('snt1', 'snt1', i)
            }

            //setTrainsByTime(300)
            var t = 60*23+50 + 2 * 24 * 60; // 0:00 ngày 2
            var animation = function() {
                setTrainsByTime(t);
                updateTimer(t);
                t += 0.3;
                if (t >= 3 * 24 * 60) {
                    resetLastPost()
                    t = t - 1 * 24 * 60
                }
                setTimeout(animation, 100);
            }
            animation()

            // console.log('ok')
        })




        </script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-10566725-2', 'auto');
          ga('send', 'pageview');

        </script>

    </body>

</html>
