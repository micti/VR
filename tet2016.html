<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Tet 2016</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <!-- <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css"> -->

        <style type="text/css">

            svg {
                font-family: "Helvetica Neue", Helvetica;
            }

            .line {
                stroke-width: 1px;
                stroke: #000;
            }

            .station {
                stroke-width: 0px;
                fill: red;
            }

            .train {
                stroke-width: 0px;
                fill: blue;
            }

        </style>

    </head>
    <body>


        <!-- Add your site or application content here -->
        <p>Ke hoach chay tau tet</p>

        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script>
        var lineLength = 1276,
            scaleRatio = 2,
            width = 500,
            height = (lineLength + 10) * scaleRatio;

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var scale = d3.scaleLinear().domain([0, 1726]).range([0, 1726 * scaleRatio])

        // 1. KM Axis
        var axisKM = d3.axisLeft(scale);
        svg.append('g')
            .attr("transform", "translate(40,5)")
            .call(axisKM)

        // 2. Route
        var route = svg.append('g')
            .attr("class", "route")
            .attr("transform", "translate(100,5)")


        // load data and process
        d3.json("train.json", function(train) {
            // process flexiable data for D3
            var dataLines = [];
            var i = 0;
            for (var d in train.connections) {
                dataLines[i] = train.connections[d];
                i++;
            }

            var dataStations = [];
            var i = 0;
            for (var d in train.stations) {
                dataStations[i] = train.stations[d];
                i++;
            }

            var lines = route.selectAll('.line').data(dataLines)
            var stations = route.selectAll('.station').data(dataStations)

            lines.enter().append('line')
                .attr('class', 'line')
                .attr('x1', 0)
                .attr('y1', function (d) { return scale(train.stations[d.station1].postKm); })
                .attr('x2', 0)
                .attr('y2', function (d) { return scale(train.stations[d.station2].postKm); });

            stations.enter().append('circle')
                .attr('class', 'station')
                .attr("cx", 0)
                .attr("cy", function(d) { return (scale(d.postKm)); })
                .attr("r", 2);

            // Train by time simulation
            startTimeForSimulation = 0;

            var se1 = route.append('circle')
                .attr('id', 'train_se1')
                .attr('class', 'train')
                .attr("cx", 0)
                .attr("cy", 0)
                .attr("r", 2)
                .style("opacity", 0);

            var se1LastRoute = null;
            var setTrainByTime = function(t) {
                if (t < train.train.se1.start) {
                    se1.style("opacity", 0);
                    return;
                }

                if (t > train.train.se1.end) {
                    se1.style("opacity", 0);
                    return;
                }

                var route = 0;
                if (se1LastRoute === null) {
                    var totalRoutes = train.train.se1.route.length;
                    var totalTimes = train.train.se1.end - train.train.se1.start;
                    var avgTimeForRoute = totalTimes / totalRoutes;
                    var time = t - train.train.se1.start;
                    var preRoutes = Math.round(time / avgTimeForRoute) - 1;
                    preRoutes = preRoutes > totalRoutes ? totalRoutes : preRoutes;
                    var direction = 1;
                    if (t < train.train.se1.route[preRoutes].realTime1Out) {
                        direction = -1;
                    }

                    do {
                        if (train.train.se1.route[preRoutes].realTime1Out <= t && train.train.se1.route[preRoutes].realTime2Out >= t) {
                            route = preRoutes;
                            break;
                        }
                        preRoutes = preRoutes + direction;
                    } while (true)
                } else {
                    route = se1LastRoute;
                    do {
                        if (train.train.se1.route[route].realTime1Out <= t && train.train.se1.route[route].realTime2Out >= t) {
                            break;
                        }
                        route++;
                    } while (true)
                }

                var station1 = train.train.se1.route[route].station1
                var station2 = train.train.se1.route[route].station2
                var routeLenght = train.stations[station2].postKm - train.stations[station1].postKm;
                var routeDuration = train.train.se1.route[route].realTime2In - train.train.se1.route[route].realTime1Out;
                var routeRunningTime = train.train.se1.route[route].realTime2In - t;
                if (routeRunningTime < 0) routeRunningTime = 0;
                routeRunningTime = routeDuration - routeRunningTime;
                var currentPos = train.stations[station1].postKm + routeRunningTime * routeLenght / routeDuration;
                se1.style("opacity", 1);
                se1.attr("cy", currentPos * scaleRatio)
                se1LastRoute = route
            }

            //setTrainByTime(2000)
            var t = 2000;
            var animation = function() {
                setTrainByTime(t);
                t += 0.4;
                setTimeout(animation, 100);
            }
            animation()
        })

        </script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <!-- <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='https://www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X','auto');ga('send','pageview');
        </script> -->

    </body>

</html>
