<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Tàu tết Đinh Dậu 2017</title>
        <meta name="description" content="Giờ tàu, giá vé, kế hoạch chạy tàu tết 2017 Đinh Dậu">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="/client/css/normalize.css">
        <link rel="stylesheet" href="/client/css/tet2017.css">
        <!-- <link rel="stylesheet" href="css/main.css"> -->
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro&amp;subset=vietnamese" rel="stylesheet">

        <style type="text/css">

            body {
                font-family: 'Source Sans Pro', sans-serif;
            }

            svg {
                font-family: 'Source Sans Pro', sans-serif;
            }

            .line {
                stroke-width: 1px;
                stroke: #000;
            }

            .station {
                stroke-width: 0px;
                fill: red;
            }

            .train {
                stroke-width: 0px;
                fill: blue;
            }



            .train_label {
                font-size: 12px;
            }

            .headline {
                position: fixed;
                bottom: 200px;
                left: 300px;
                width: 300px;
                background: #000;
                color: #fff;
                padding: 3px;
                line-height: 1.3;
            }

        </style>

    </head>
    <body>
        <div class="container">
            <h1>Tàu tết Đinh Dậu 2017<small>&lt;Đang cập nhật&gt;</small></h1>
            <p>Cả ngành ĐSVN bỗng thu bé lại vừa bằng 1 cái tết</p>
            <p>Thông tin chi tiết về kế hoạch chạy tàu tết 2017 của đường sắt Việt Nam được biên tập lại trong 1 trang web duy nhất, dành cho các bạn quan tâm đến tàu tết trên CLB Đam mê Đường sắt, hi vọng đây là nguồn tham khảo bổ ích cho những ai quân tâm đến ngành đường sắt, các bạn đang học các ngành liên quan đến vận tải kinh tế đường sắt...</p>
            <p>CHÚ Ý: Đây không phải là trang web chính thức của ngành đường sắt, website không cung cấp các chức năng bán vé cũng như các thông tin chính thống và mới nhất về tàu tết 2017, nếu là hành khách có nhu cầu mua vé, xin vui lòng truy cập trang web http://dsvn.vn, để xem giờ tàu giá vé, xin vui lòng truy cập trang web http://giotaugiave.dsvn.vn/</p>
            <p>Dữ liệu: Kế hoạch chạy tàu tết của ĐSVN, http://dsvn.vn<br>Biên tập: Lê Nhật Anh, Nguyễn Thành Bình Nguyên (CLB Đam mê Đường sắt)<br>Thiết kế: Lê Nhật Anh<br>Chỉnh sửa lần cuối: 08 tháng 12, 2016<br>(c) 2017 . Giấy phép: MIT cho mã nguồn, CC BY 4.0 cho nội dung.</p>
            <h2>Thời gian</h2>
            <p>Đang cập nhật</p>
            <h2>Ram xe</h2>
            <p>Đang cập nhật</p>
            <h2>Lịch chạy</h2>
            <p>Đang cập nhật</p>
            <h2>Đầu máy</h2>
            <p>Đang cập nhật</p>
            <h2>Biểu đồ chạy tàu</h2>
            <h3>Mô phỏng biểu đồ</h3>
            <p>Đang cập nhật</p>

            <div id="bieudo_mophong">
                <div id="bieudo_thongtin">
                    <span id="timer">00:00</span>
                </div>
                <div id="bieudo"></div>
            </div>
            <h3>Biểu đồ chạy tàu</h3>
            <div id="bieudo_chaytau">
                <div id="bieudo_chaytau_time_svg"></div>
                <div id="bieudo_chaytau_station_svg"></div>
                <div id="bieudo_chaytau_svg"></div>
            </div>

            <h2>Vé</h2>
            <p>Đang cập nhật</p>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="/client/js/d3.min.js"></script>
        <script>
        // Layout


        // extend d3
        d3.selection.prototype.moveToBack = function() {
            return this.each(function() {
                var firstChild = this.parentNode.firstChild;
                if (firstChild) {
                    this.parentNode.insertBefore(this, firstChild);
                }
            });
        }
        d3.selection.prototype.moveToFront = function() {
            return this.each(function(){
                this.parentNode.appendChild(this);
            });
        }

        var lineLength = 1726,
            scaleRatio = 3,
            width = 1200,
            height = (lineLength + 20) * scaleRatio;

        var svg = d3.select("#bieudo").append("svg")
            .attr("width", 250)
            .attr("height", height);

        var bieudoSVG = d3.select("#bieudo_chaytau_svg").append("svg")
            .attr("width", 24 * 42 + 70)
            .attr("height", lineLength * scaleRatio + 50);

        var scaleStation = scale = d3.scaleLinear().domain([0, 1726]).range([0, 1726 * scaleRatio])
        var scaleTime = d3.scaleTime()
            .domain([new Date(2016, 0, 15, 0), new Date(2016, 0, 16, 0)])
            .range([0, 24 * 42])
        var lineForMarley = d3.line()
            .y(function(d) { return scaleStation(d.km) })
            .x(function(d) { return scaleTime(d.time) })

        // 1. KM Axis
        var axisKM = d3.axisLeft(scale);
        svg.append('g')
            .attr("transform", "translate(40,20)")
            .call(axisKM)

        // 2. Marley time Axis
        var bieudoTimeSVG = d3.select("#bieudo_chaytau_time_svg").append("svg")
            .attr("width", 24 * 42 + 122)
            .attr("height", 20);
        var bieudoStationSVG = d3.select("#bieudo_chaytau_station_svg").append("svg")
            .attr("width", 50)
            .attr("height", lineLength * scaleRatio + 50);
        var axisTime = d3.axisTop(scaleTime)
            .ticks(24)
            .tickFormat(d3.timeFormat("%H:%M"))
        bieudoTimeSVG.append('g')
            .attr("transform", "translate(50,20)")
            .call(axisTime)

        //2.1 Line


        // 2. Route
        var routeSvg = svg.append('g')
            .attr("class", "route")
            .attr("transform", "translate(200,20)")
            .attr("font-size", "12px")

        var praseTimeString = function(time) {
            time = time.split(":")
            return new Date(2016, 0, 15, parseInt(time[0]), parseInt(time[1], 0))
        }

        // load data and process
        d3.json("data/tet2017.json", function(data) {
            // process flexiable data for D3
            var dataLines = [];
            var i = 0;
            for (var d in data.sections) {
                dataLines[i] = data.sections[d];
                i++;
            }

            var dataStations = [];
            var i = 0;
            for (var d in data.stations) {
                dataStations[i] = data.stations[d];
                i++;
            }

            var lines = routeSvg.selectAll('.line').data(dataLines)
            var stations = routeSvg.selectAll('.station').data(dataStations)
            var stationLabels = routeSvg.selectAll('.station_label').data(dataStations)
            var stationTicks = routeSvg.selectAll('.station_tick').data(dataStations)

            lines.enter().append('line')
                .attr('class', 'line')
                .attr('x1', 0)
                .style('shape-rendering','crispEdges')
                .attr('y1', function (d) { return scale(data.stations[d.station1].km); })
                .attr('x2', 0)
                .attr('y2', function (d) { return scale(data.stations[d.station2].km); });

            // stations.enter().append('circle')
            //     .attr('class', 'station')
            //     .attr("cx", 0)
            //     .attr("cy", function(d) { return (scale(d.postKm)); })
            //     .attr("r", 2)

            stationLabels.enter().append('text')
                .attr('class', 'station_label')
                .attr("x", function (d, i) { return i % 2 === 0 ? '-75' : '-15'})
                .attr("y", function (d) { return (scale(d.km)); })
                .attr("dy", "0.32em")
                .text(function (d) { return d.name })

            stationTicks.enter().append('line')
                .attr('class', 'station_tick')
                .attr('fill', 'none')
                .attr('stroke', '#000')
                .style('shape-rendering','crispEdges')
                .attr("y2", function (d, i) { return (scale(d.km)) })
                .attr("y1", function (d, i) { return (scale(d.km)) })
                .attr("x1", function (d, i) { return i % 2 === 0 ? '-70' : '-10'})
                .attr("x2", "-3")

            var timeToMin = function(time)
            {
                parts = time.split(":")
                return parseInt(parts[0]) * 60 + parseInt(parts[1])
            }

            var dayToMin = function(day) {
                return day * 24 * 60
            }

            // Train data
            var trains = []
            var trainCircles = []
            var trainLastPos = []
            var trainLabels = []

            var setTrainsByTime = function(time)
            {
                var total = trains.length
                for (i = 0; i < total; i++) {
                    setTrainByTime(i, time)
                }
            }

            var setTrainByTime = function(index, time) {
                if (time < trains[index].start) {
                    trainCircles[index].style("opacity", 0)
                    trainLabels[index].style("opacity", 0)
                    return;
                }

                if (time > trains[index].end) {
                    trainCircles[index].style("opacity", 0)
                    trainLabels[index].style("opacity", 0)
                    return;
                }

                var route = 0
                if (trainLastPos[index] === null) {
                    var totalRoutes = trains[index].route.length
                    var totalTimes = trains[index].end - trains[index].start
                    var avgTimeForRoute = totalTimes / totalRoutes
                    var currentTime = time - trains[index].start
                    var preRoutes = Math.ceil(currentTime / avgTimeForRoute) - 1
                    preRoutes = preRoutes < 0 ? 0 : preRoutes
                    preRoutes = preRoutes > totalRoutes ? totalRoutes : preRoutes
                    var direction = 1
                    if (time < trains[index].route[preRoutes].start) {
                        direction = -1
                    }

                    do {
                        if (trains[index].route[preRoutes].start <= time && trains[index].route[preRoutes].out >= time) {
                            route = preRoutes
                            break;
                        }
                        preRoutes = preRoutes + direction
                    } while (true)
                } else {
                    route = trainLastPos[index]
                    do {
                        if (trains[index].route[route].start <= time && trains[index].route[route].out >= time) {
                            break
                        }
                        route++
                    } while (true)
                }

                var station1 = trains[index].route[route].station1
                var station2 = trains[index].route[route].station2
                var routeLenght = data.stations[station2].km - data.stations[station1].km;
                var routeDuration = trains[index].route[route].in - trains[index].route[route].start;
                var routeRunningTime = trains[index].route[route].in - time;
                if (routeRunningTime < 0) routeRunningTime = 0;
                routeRunningTime = routeDuration - routeRunningTime;
                var currentPos = data.stations[station1].km + routeRunningTime * routeLenght / routeDuration;
                trainCircles[index].style("opacity", 1);
                trainCircles[index].attr("cy", currentPos * scaleRatio)
                trainCircles[index].attr("cy", currentPos * scaleRatio)
                trainLabels[index].style("opacity", 1);
                trainLabels[index].attr("y", currentPos * scaleRatio)
                trainLastPos[index] = route
            }

            var createTrain = function(name, route, day)
            {
                var train = {
                    'name': name + '_' + day,
                    'start': '',
                    'end': '',
                    'route': []
                }

                var i = 0;
                for (var key in data.routes[route].sections) {
                    var dayStart = data.routes[route].sections[key].time1OutDay + day
                    var dayIn = data.routes[route].sections[key].time2InDay + day
                    var dayOut = data.routes[route].sections[key].time2OutDay + day
                    var timeStart = timeToMin(data.routes[route].sections[key].time1Out)
                    var timeIn = timeToMin(data.routes[route].sections[key].time2In)
                    var timeOut = timeToMin(data.routes[route].sections[key].time2Out)

                    train.route[i] = {}
                    train.route[i].start = timeStart + dayToMin(dayStart)
                    train.route[i].in = timeIn + dayToMin(dayIn)
                    train.route[i].out = timeOut + dayToMin(dayOut)
                    train.route[i].station1 = data.routes[route].sections[key].station1
                    train.route[i].station2 = data.routes[route].sections[key].station2

                    i++;
                }

                train.start = train.route[0].start
                train.end = train.route[i-1].out

                // add data
                trains.push(train)

                // add cirlce
                var cir = routeSvg.append('circle')
                    //.attr('id', 'train_se1')
                    .attr('class', 'train')
                    .attr("cx", 0)
                    .attr("cy", 0)
                    .attr("r", 2)
                    .style("opacity", 0)
                trainCircles.push(cir)

                // add label
                var text = routeSvg.append('text')
                    .attr('class', 'train_label')
                    .attr("x", 5)
                    .attr("y", 0)
                    .attr("dy", "0.32em")
                    .text(train.name)
                    .style("opacity", 0)
                trainLabels.push(text)

                trainLastPos.push(null)
            }

            var resetLastPos = function() {
                for (var pos in trainLastPos) {
                    trainLastPos[pos] = null
                }
            }

            var timer = d3.select("#timer")

            var updateTimer = function(time) {
                var midnightToNow = Math.round(time) % (60 * 24);
                var hh = Math.floor(midnightToNow / 60);
                var mm = midnightToNow - (hh * 60);

                hh = hh < 10 ? '0' + hh : hh;
                mm = mm < 10 ? '0' + mm : mm;

                timer.text(hh + ":" + mm + ":00")
            }

            for(i = 0; i <= 4; i++) {
                createTrain('se1', 'se1', i)
                createTrain('se3', 'se3', i)
                createTrain('se5', 'se5', i)
                createTrain('se7', 'se7', i)
                createTrain('tn1', 'tn1', i)
                createTrain('tn3', 'tn3', i)
                createTrain('tn5', 'tn5', i)
                createTrain('tn7', 'tn7', i)
                createTrain('se9', 'se9', i)
                createTrain('se11', 'se11', i)
                createTrain('se13', 'se13', i)
                createTrain('se14', 'se14', i)
                createTrain('se17', 'se17', i)
                createTrain('se18', 'se18', i)
                createTrain('se29', 'se29', i)
                createTrain('se30', 'se30', i)
                createTrain('se23', 'se23', i)
                createTrain('se24', 'se24', i)
                createTrain('sqn1', 'sqn1', i)
                createTrain('sqn2', 'sqn2', i)
                createTrain('snt2', 'snt2', i)
                createTrain('snt4', 'snt4', i)
                createTrain('snt3', 'snt3', i)
                createTrain('se2', 'se2', i)
                createTrain('se4', 'se4', i)
                createTrain('se6', 'se6', i)
                createTrain('se8', 'se8', i)
                createTrain('tn2', 'tn2', i)
                createTrain('tn4', 'tn4', i)
                createTrain('tn6', 'tn6', i)
                createTrain('tn8', 'tn8', i)
                createTrain('se10', 'se10', i)
                createTrain('se12', 'se12', i)
                createTrain('spt2', 'spt2', i)
                createTrain('se22', 'se22', i)
                createTrain('se26', 'se26', i)
                createTrain('snt2', 'snt2', i)
                createTrain('spt1', 'spt1', i)
                createTrain('se21', 'se21', i)
                createTrain('se25', 'se25', i)
                createTrain('snt1', 'snt1', i)
            }

            //setTrainsByTime(300)
            var t = 2 * 24 * 60; // 0:00 ngày 2
            var animation = function() {
                setTrainsByTime(t);
                updateTimer(t);
                t += 0.3;
                if (t >= 3 * 24 * 60) {
                    resetLastPos()
                    t = t - 1 * 24 * 60
                }
                setTimeout(animation, 100);
            }
            animation()

            /**
             * Vẽ biểu đồ
             */

            // Dữ liệu
            var dataTimeTable = []

            var getTrainDiagramData = function(route)
            {
                var point = []
                var i = 0
                var lastKm = 0
                var lastTime = '000:000'
                point[i] = []

                var addPoint = function(km, time, type) {
                    if (time === lastTime) {
                        return;
                    }

                    if (timeToMin(time) < timeToMin(lastTime)) {
                        console.log(time, lastTime, route)
                        var l = km - lastKm
                        var t1 = timeToMin('24:00') - timeToMin(lastTime)
                        var t2 = timeToMin(time) - 0
                        var km1 = Math.floor(t1 / (t1 + t2) * l) + lastKm
                        point[i].push({km: km1, time: praseTimeString('24:00')})
                        i++
                        point[i] = []
                        point[i].push({km: km1, time: praseTimeString('00:00')})
                    }

                    point[i].push({km: km, time: praseTimeString(time), t: 's', ti: time, type: type})
                    lastKm = km
                    lastTime = time
                }

                var count = 0
                for (var section in data.routes[route].sections) {
                    var info = data.routes[route].sections[section];
                    if (count === 0) {
                        addPoint(data.stations[info.station1].km, info.time1In, 'i')
                        addPoint(data.stations[info.station1].km, info.time1Out, 'o')
                    }
                    addPoint(data.stations[info.station2].km, info.time2In, 'i')
                    addPoint(data.stations[info.station2].km, info.time2Out, 'o')
                    count++
                }

                return {route: route, point: point}
            }

            for (var route in data.routes) {
                dataTimeTable.push(getTrainDiagramData(route))
            }

            var formatTime = function (time) {
                var a = time.split(":")
                return "." + a[1]
            }

            // Chú thích ga
            var diagramHelper = bieudoStationSVG.append('g')
                .attr("transform", "translate(0,30)")
                .attr("class", "station_helper")
            .selectAll('g')
                .data(dataStations)

            var lineHelper = bieudoSVG.append('g')
                .attr("transform", "translate(50,30)")
                .attr("class", "line_helper")
            .selectAll('g')
                .data(dataStations)

            diagramHelper.enter().append('text')
                .attr("x", function (d, i) { return i % 2 === 0 ? '0' : '20'})
                .attr("y", function (d) { return (scale(d.km)); })
                .attr("dy", "0.32em")
                .text(function (d) { return d.code })

            lineHelper.enter().append('line')
                .attr("y2", function (d, i) { return (scaleStation(d.km)) })
                .attr("y1", function (d, i) { return (scaleStation(d.km)) })
                .attr("x1", 0)
                .attr("x2", 24 * 42)

            // Chú thích giờ
            var timeHelper = bieudoSVG.append('g')
                .attr("transform", "translate(50,0)")
                .attr("class", "time_helper")
            .selectAll('g')
                .data([
                    '00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00',
                    '07:00', '08:00', '09:00', '10:00', '11:00', '12:00',
                    '13:00', '14:00', '15:00', '16:00', '17:00', '18:00',
                    '19:00', '20:00', '21:00', '22:00', '23:00', '00:00'
                ])

            timeHelper.enter().append('line')
                .attr("y1", 30)
                .attr("x1", function (d, i) { return i * 42 })
                .attr("x2", function (d, i) { return i * 42 })
                .attr("y2", 30 + lineLength * scaleRatio)

            // Tạp biểu đồ
            var trainPath = bieudoSVG.append('g')
                .attr("transform", "translate(50,30)")
            .selectAll("g")
                .data(dataTimeTable)
            .enter().append("g")
                .attr("class", function(d) { return "train_detail " + d.route; })
            .selectAll("g")
                .data(function (d) { return d.point })
            .enter()

            trainPath.append("path")
                .attr("d", function(d) { return lineForMarley(d); })
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut);

            trainPath.selectAll("circle")
                .data(function(d) { return d.filter(function (d){ return d.t === 's'}) })
            .enter().append("circle")
                .style('opacity', 0)
                .attr("transform", function(d) {
                    return "translate(" + scaleTime(d.time) + "," + scaleStation(d.km) + ")";
                })
                .attr("r", 2)

            trainPath.selectAll("text")
                .data(function(d) { return d.filter(function (d){ return d.t === 's'}) })
            .enter().append("text")
                .style('opacity', 0)
                .attr("transform", function(d) {
                    var adjust = 5
                    if (d.type === 'i') adjust = -15
                    return "translate(" + (scaleTime(d.time) + adjust) + "," + (scaleStation(d.km) + 3) + ")";
                })
                .text(function(d) { return formatTime(d.ti) })

            // position
            var w = $(window);
            var inner = $("#bieudo_chaytau");
            w.on('scroll', function() {
                var bieudo_offset_top = $("#bieudo_chaytau").offset().top
                var bieudo_h = $("#bieudo_chaytau").outerHeight()
                var window_scroll_h = w.scrollTop()
                if (window_scroll_h > bieudo_offset_top && window_scroll_h < bieudo_offset_top + bieudo_h - 40) {
                    $("#bieudo_chaytau_time_svg").css('top', window_scroll_h - bieudo_offset_top)
                } else {
                    $("#bieudo_chaytau_time_svg").css('top', 0)
                }

                var bieudo_mophong_offset_top = $("#bieudo_mophong").offset().top
                var bieudo_mophong_h = $("#bieudo_mophong").outerHeight()

                if (window_scroll_h > bieudo_mophong_offset_top && window_scroll_h < bieudo_mophong_offset_top + bieudo_mophong_h - 250) {
                    $("#bieudo_thongtin").css('top', window_scroll_h - bieudo_mophong_offset_top)
                } else if (window_scroll_h <= bieudo_mophong_offset_top) {
                    $("#bieudo_thongtin").css('top', 0)
                }
            })
            inner.on('scroll', function() {
                var inner_scroll_left = inner.scrollLeft()
                    $("#bieudo_chaytau_station_svg").css('left', inner_scroll_left)
            })
        })

        function handleMouseOver(d, i) {  // Add interactivity
            d3.select(this.parentNode).selectAll('text').style('opacity', 1)
            d3.select(this.parentNode).selectAll('circle').style('opacity', 1)
            d3.select(this.parentNode).moveToFront()
        }

        function handleMouseOut(d, i) {
            d3.select(this.parentNode).selectAll('text').style('opacity', 0)
            d3.select(this.parentNode).selectAll('circle').style('opacity', 0)
        }


        </script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-10566725-2', 'auto');
          ga('send', 'pageview');

        </script>

    </body>

</html>
